@using K9.Base.WebApplication.Helpers
@using K9.SharedLibrary.Helpers
@using K9.WebApplication.Options
@model K9.WebApplication.ViewModels.ArticleDynamicFieldsViewModel

<div class="row">
    <div class="col-sm-12">
        <div class="form-group margin-bottom-0">
            @Html.Partial("../Shared/Controls/_ImageUploader", new ImageUploadOptions
            {
                UploadUrl = Url.Action("UploadImage", new { articleId = Model.ArticleId })
            })
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <div class="form-group">
            <label for="imageFields">@Dictionary.Images:</label>
            <small class="text-muted" style="display: block; margin-top: -5px; margin-bottom: 8px;">
                Ctrl+C to copy image element markup. Ctrl+Shift+C to copy image URL.
            </small>
            <select id="imageFields" class="form-control" multiple size="11">
                @Html.Partial("_ImageOptions")
            </select>
        </div>
    </div>
    <div class="col-sm-12">
        <div class="form-group margin-bottom-0">
            <button type="button" id="deleteSelectedImages" class="btn btn-danger">
                <i class="glyphicon glyphicon-trash"></i> @Dictionary.DeleteSelected
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">

    $('#deleteSelectedImages').on('click', function () {
        const $btn = $(this);
        const $select = $('#imageFields');
        const $selected = $select.find('option:selected');

        if ($selected.length === 0) {
            alert('Please select one or more images to delete.');
            return;
        }

        if (!confirm('Are you sure you want to delete the selected image(s)?')) {
            return;
        }

        const urlsToDelete = $selected.map(function () {
            return $(this).data('url');
        }).get();

        // Disable + show spinner
        $btn.prop('disabled', true);
        $.fn.displaySpinner($btn, true);

        $.ajax({
            url: '@Url.Action("DeleteImages")',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ urls: urlsToDelete }),
            success: function () {
                // Reload image field options
                $.get('@Url.Action("GetImageOptions")', { articleId: @Model.ArticleId }, function (data) {
                    $select.html(data);
                });
            },
            error: function () {
                alert('Failed to delete one or more images.');
            },
            complete: function () {
                $btn.prop('disabled', false);
                $.fn.hideSpinner($btn);
            }
        });
    });

    function refreshImageOptions(articleId) {
        $.get('@Url.Action("GetImageOptions")', { articleId: @Model.ArticleId }, function (data) {
            $('#imageFields').html(data);
        });
    }

    $("#imageFields").on("keydown", function (event) {
        if (event.ctrlKey && event.key.toLowerCase() === "c") {
            const selectedOptions = $(this).find("option:selected");

            if (selectedOptions.length === 0) {
                return;
            }

            let textToCopy;

            if (event.shiftKey) {
                // Ctrl + Shift + C → copy plain URLs
                textToCopy = selectedOptions.map(function () {
                    return $(this).data("url");
                }).get().join("\n");
            } else {
                // Ctrl + C → copy placeholder markup
                textToCopy = selectedOptions.map(function () {
                    return $(this).val();
                }).get().join("\n");
            }

            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy)
                    .catch(err => console.error("Failed to copy:", err));
            }

            event.preventDefault(); // optional: prevents browser default copy
        }
    });

    document.addEventListener('imageUploaded', function () {
        refreshImageOptions(@Model.ArticleId);
    });

</script>