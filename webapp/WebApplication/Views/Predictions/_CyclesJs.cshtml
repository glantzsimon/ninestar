@using K9.WebApplication.Enums
@model K9.WebApplication.Models.NineStarKiModel

<script language="javascript">

    function scrollCurrentYearIntoVew() {
        setTimeout(function() {
                var $cycle = $("div.current-year");
                var $yearlyPlannerContainer = ".yearly-planner-container";

                $($yearlyPlannerContainer).scrollTop($cycle.offset().top - $($yearlyPlannerContainer).offset().top);
            },
            200);
    }

    function scrollCurrentMonthIntoVew() {
        setTimeout(function() {
                var $cycle = $("div.current-month");
                var $monthlyPlannerContainer = ".monthly-planner-container";

                $($monthlyPlannerContainer).scrollTop($cycle.offset().top - $($monthlyPlannerContainer).offset().top);
            },
            200);
    }

    function scrollActivePlannerItemIntoVew() {
        if ($("#PlannerEnableScrollIntoView").val() === 'True') {
            setTimeout(function() {
                    var $cycle = $(".year-block .active");
                    var $container = $(".global-planner-container");

                    $container.scrollTop($cycle.offset().top - $container.offset().top - 154);

                    $("#PlannerEnableScrollIntoView").val(false);
                },
                200);
        }
    }

    function scrollCyclesIntoVew(tab) {
        setTimeout(function() {
                $.fn.scrollToTopOf(tab, -230);
            },
            200);
    }

    $(function() {
        $("a[href='#yearly-planner']").click(function() {
            scrollCurrentYearIntoVew();
        });

        $("a[href='#monthly-planner']").click(function() {
            scrollCurrentMonthIntoVew();
        });

        $("#current-yearly-cycle").click(function() {
            scrollCyclesIntoVew("#yearly");

            $(".nav-pills a[href='#predictions']").tab("show");
            $(".nav-pills a[href='#yearly']").tab("show");
        });

        $("#current-monthly-cycle").click(function() {
            scrollCyclesIntoVew("#monthly");

            $(".nav-pills a[href='#predictions']").tab("show");
            $(".nav-pills a[href='#monthly']").tab("show");
        });

        $("a[href='#global-planner']").click(function() {
            scrollActivePlannerItemIntoVew();
        });

        // Dril up or down
        $(".global-planner-item").dblclick(function() {
            var $el = $(this);
            var url = '@Url.Action("GetPlanner")';
            var view = $el.attr("data-view");
            var selectedDate = $el.attr("data-selected-date");
            
            // Update planner
            ajaxcontroller().get(dailyCalendarUrl,
                {
                    dateOfBirth: '@Model.PersonModel.DateOfBirth.ToString("yyyy-MM-dd")',
                    birthTimeZoneId: "@Model.PersonModel.BirthTimeZoneId",
                    timeOfBirth: '@Model.PersonModel.TimeOfBirth.ToString()',
                    gender: '@Model.PersonModel.Gender',
                    selectedDateTime: selectedDate,
                    userTimeZoneId: '@Model.UserTimeZoneId',
                    calculationMethod: '@Model.CalculationMethod.ToString()',
                    useHolograhpicCycleCalculation: '@Model.UseHolograhpicCycleCalculation.ToString().ToLower()',
                    invertDailyAndHourlyKiForSouthernHemisphere: '@Model.InvertDailyAndHourlyKiForSouthernHemisphere.ToString().ToLower()',
                    invertDailyAndHourlyCycleKiForSouthernHemisphere: '@Model.InvertDailyAndHourlyCycleKiForSouthernHemisphere.ToString().ToLower()',
                    view: view,
                }).done(
                function(result) {
                    if (result.success) {
                        $("#global-planner-container").html(result.data);
                    }
                });
        });

        $(".global-planner-item").click(function() {
            var $el = $(this);
            var energy = $el.attr("data-energy");
            var type = $el.attr("data-type");
            var url = '@Url.Action("GetPlanner")';
            var view = $el.Attr("data-view");
            var selectedDate = $el.attr("data-selected-date");
            var $container, $parentBlock, $childBlock, $details, url;

            $container = $el.closest(".global-planner-container");
            $parentBlock = $el.closest(".parent-block");
            $childBlock = $el.find(".child-block");
            $details = $("#global-planner-details");

            // clear current class from all items
            $container.find(".parent-block, .child-block").removeClass("active");

            // set current class on current selected item
            if (type === "parent") {
                $parentBlock.addClass("active");
            }
            else if (type === "child") {
                $childBlock.addClass("active");
            }

            // Display selected child / parent data
            ajaxcontroller().get(url, {energy}).done(
                function(result) {
                    if (result.success) {
                        $details.find(".panel .panel-heading h4 strong").html(result.data.CycleDescriptiveName);
                        $details.find(".panel .panel-body").html(result.data.CycleDescription);
                    }
                });

            setTimeout(function () {
                if (!$.fn.isVisible($details))
                    $.fn.scrollToTopOf($details, -180);
            }, 200);
        });

        $(".planner-item").click(function() {
            var $el = $(this);
            var energy = $el.attr("data-energy");
            var type = $el.attr("data-type");
            var $container, $plannerItem, $details;
            var url = "";

            switch (type) {
                case "year":
                    $details = $("#yearly-planner-details");
                    url = '@Url.Action("GetYearlyForecast", "Predictions")';
                    break;

                default:
                    $details = $("#monthly-planner-details");
                    url = '@Url.Action("GetMonthlyForecast", "Predictions")';
                    break;
            }

            $container = $el.closest(".planner-container");
            $plannerItem = $el.find(".planner-item-container");

            // clear current class from all items
            $container.find(".planner-item .planner-item-container").removeClass("active");

            // set current class on current selected item
            $plannerItem.addClass("active");

            ajaxcontroller().get(url, {energy}).done(
                function(result) {
                    if (result.success) {
                        $details.find(".panel .panel-heading h4 strong").html(result.data.CycleDescriptiveName);
                        $details.find(".panel .panel-body").html(result.data.CycleDescription);
                    }
                });
        });
    });

</script>